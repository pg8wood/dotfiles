#!/bin/bash

# Strip out ".xcodeproj" extension to enable tab completion for this script in the ios-register repo
module_name=${1%.xcodeproj}
shift # Remove module name argument from the list of arguments

# Capture any additional arguments passed after the module name
additional_args="$@"

# Run build script,
build_project() {
    sq gen "$module_name" -a -n "$module_name" $additional_args 
}

# Run the build function
build_project

# Check if the build output contains the gem/pod error
if grep -qE "Could not find.*in locally installed gems" /tmp/build_output.log; then
    echo "Detected missing gems. Running bundle install..."
    bundle install

    # Retry the build after installing gems
    build_project

    # Check again if it fails a second time
    if grep -qE "Could not find.*in locally installed gems" /tmp/build_output.log; then
        echo "Retry failed. Please check gem dependencies manually."
        exit 1
    else
        echo "Build succeeded after installing missing gems."
    fi
else
    echo "Build succeeded."
fi

# 3. Trigger Run in Xcode once indexing is ready
echo -e "\nWaiting for Xcode indexing to finish so we can Run..."

trigger_xcode_run() {
    osascript <<'END' 2>&1
log "‚Üí Activating Xcode..."
tell application "Xcode"
    activate
end tell

log "‚Üí Waiting for Xcode UI to be ready..."
delay 0.5

tell application "System Events"
    tell process "Xcode"
        log "‚Üí Checking for Run menu item availability..."
        
        -- Wait until the Run menu item is enabled
        set checkCount to 0
        repeat
            try
                if (enabled of menu item "Run" of menu "Product" of menu bar item "Product" of menu bar 1) is true then
                    log "‚úì Run menu item is ready!"
                    exit repeat
                end if
            end try
            
            set checkCount to checkCount + 1
            if checkCount mod 5 = 0 then
                log "  Still waiting for indexing... (" & checkCount & "s elapsed)"
            end if
            
            delay 1
        end repeat
        
        log "‚Üí Clicking Run menu item..."
        click menu item "Run" of menu "Product" of menu bar item "Product" of menu bar 1
        log "‚úì Run command sent successfully!"
    end tell
end tell
END
}

# Retry logic with exponential backoff
max_retries=3
retry_count=0
retry_delay=2

while [ $retry_count -lt $max_retries ]; do
    output=$(trigger_xcode_run)
    exit_code=$?
    
    if [ $exit_code -eq 0 ]; then
        echo "Run triggered in Xcode üöÄ"
        break
    else
        retry_count=$((retry_count + 1))
        echo "‚ö†Ô∏è  Attempt $retry_count failed with error:"
        echo "$output"
        
        if [ $retry_count -lt $max_retries ]; then
            echo "Retrying in ${retry_delay}s..."
            sleep $retry_delay
            retry_delay=$((retry_delay * 2))  # Exponential backoff
        else
            echo "‚ùå Failed to trigger Run after $max_retries attempts."
            echo "You may need to manually click Run in Xcode."
        fi
    fi
done

# Cleanup temporary file
rm /tmp/build_output.log
