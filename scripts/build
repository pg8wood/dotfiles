#!/bin/bash

# Strip out ".xcodeproj" extension to enable tab completion for this script in the ios-register repo
module_name=${1%.xcodeproj}
shift # Remove module name argument from the list of arguments

# Capture any additional arguments passed after the module name
additional_args="$@"

# Print function with purple [superbuild] prefix
superbuild_echo() {
    local purple="\033[38;2;84;72;200m"
    local reset="\033[0m"
    echo -e "${purple}[superbuild]${reset} $*"
}

# Print error function with red [superbuild] prefix
superbuild_error() {
    local red="\033[38;2;255;0;0m"
    local reset="\033[0m"
    echo -e "${red}[superbuild]${reset} $*"
}

# Print success function with green [superbuild] prefix
superbuild_success() {
    local green="\033[38;2;0;255;0m"
    local reset="\033[0m"
    echo -e "${green}[superbuild]${reset} $*"
}

# Show starting message
superbuild_echo "Generating $module_name..."

# Run build script
sq gen "$module_name" -a -n "$module_name" $additional_args 2>&1
build_exit_code=$?

# Check if the build succeeded
if [ $build_exit_code -ne 0 ]; then
    superbuild_error "‚ùå Build failed with exit code $build_exit_code"
    exit 1
fi

superbuild_success "‚úì Build succeeded."

# 3. Trigger Run in Xcode once indexing is ready
superbuild_echo ""
superbuild_echo "Waiting for Xcode indexing to finish so we can Run..."

trigger_xcode_run() {
    osascript <<'END' 2>&1
log "‚Üí Activating Xcode..."
tell application "Xcode"
    activate
end tell

log "‚Üí Waiting for Xcode UI to be ready..."
delay 0.5

tell application "System Events"
    tell process "Xcode"
        log "‚Üí Checking for Run menu item availability..."
        
        -- Wait until the Run menu item is enabled
        set checkCount to 0
        repeat
            try
                if (enabled of menu item "Run" of menu "Product" of menu bar item "Product" of menu bar 1) is true then
                    log "‚úì Run menu item is ready!"
                    exit repeat
                end if
            end try
            
            set checkCount to checkCount + 1
            if checkCount mod 5 = 0 then
                log "  Still waiting for indexing... (" & checkCount & "s elapsed)"
            end if
            
            delay 1
        end repeat
        
        log "‚Üí Clicking Run menu item..."
        click menu item "Run" of menu "Product" of menu bar item "Product" of menu bar 1
        log "‚úì Run command sent successfully!"
    end tell
end tell
END
}

# Retry logic with exponential backoff
max_retries=3
retry_count=0
retry_delay=2

while [ $retry_count -lt $max_retries ]; do
    output=$(trigger_xcode_run)
    exit_code=$?
    
    if [ $exit_code -eq 0 ]; then
        superbuild_success "Run triggered in Xcode üöÄ"
        break
    else
        retry_count=$((retry_count + 1))
        superbuild_echo "‚ö†Ô∏è  Attempt $retry_count failed with error:"
        echo "$output"
        
        if [ $retry_count -lt $max_retries ]; then
            superbuild_echo "Retrying in ${retry_delay}s..."
            sleep $retry_delay
            retry_delay=$((retry_delay * 2))  # Exponential backoff
        else
            superbuild_error "‚ùå Failed to trigger Run after $max_retries attempts."
            superbuild_error "You may need to manually click Run in Xcode."
        fi
    fi
done
